<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物尽其用 Pro - 资产全生命周期管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        .hidden-input { display: none; }
        
        /* Markdown 样式优化 */
        .prose { color: #374151; max-width: none; }
        .prose h1, .prose h2, .prose h3 { color: #111827; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose h3 { font-size: 1.25em; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.3em; }
        .prose p { margin-bottom: 1em; line-height: 1.7; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.4em; }
        .prose strong { color: #4f46e5; font-weight: 600; }
        .prose blockquote { border-left: 4px solid #e5e7eb; padding-left: 1em; color: #6b7280; font-style: italic; }

        /* Loading 动画 */
        .typing-loader {
            width: 8px; height: 8px; border-radius: 50%;
            animation: typing 1s linear infinite alternate;
            position: relative; left: -12px;
        }
        @keyframes typing {
            0% { background-color: rgba(79, 70, 229, 1); box-shadow: 16px 0 rgba(79, 70, 229, 0.2), 32px 0 rgba(79, 70, 229, 0.2); }
            50% { background-color: rgba(79, 70, 229, 0.4); box-shadow: 16px 0 rgba(79, 70, 229, 1), 32px 0 rgba(79, 70, 229, 0.2); }
            100% { background-color: rgba(79, 70, 229, 0.2); box-shadow: 16px 0 rgba(79, 70, 229, 0.2), 32px 0 rgba(79, 70, 229, 1); }
        }
    </style>
</head>
<body class="text-gray-800 pb-20">

    <nav class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between h-auto md:h-16 items-center py-3 md:py-0 gap-3">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                        <i class="fa-solid fa-brain"></i>
                    </div>
                    <h1 class="text-lg font-bold text-gray-900">物尽其用 <span class="text-indigo-600">AI</span></h1>
                </div>
                
                <div class="flex items-center gap-3 text-sm">
                    <button onclick="openSettingsModal()" class="px-3 py-1.5 bg-white border border-gray-200 hover:border-indigo-500 text-gray-700 hover:text-indigo-600 rounded-md transition flex items-center gap-2">
                        <i class="fa-solid fa-gear"></i>设置 API
                    </button>
                    <div class="h-4 w-px bg-gray-300 mx-1"></div>
                    <button onclick="exportData()" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md transition flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> 导出
                    </button>
                    <label class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md transition flex items-center gap-2 cursor-pointer">
                        <i class="fa-solid fa-upload"></i> 导入
                        <input type="file" id="importFile" accept=".json" onchange="importData(this)" class="hidden-input">
                    </label>
                    <button onclick="clearAllData()" class="text-gray-400 hover:text-red-500 font-medium transition flex items-center gap-1 px-2" title="清空所有">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1 bg-indigo-500"></div>
                <div class="text-sm font-medium text-gray-500 mb-1">净投入总额</div>
                <div class="text-2xl font-bold text-gray-900" id="stat-total-net">¥0.00</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1 bg-blue-500"></div>
                <div class="text-sm font-medium text-gray-500 mb-1">当前每日消耗</div>
                <div class="text-2xl font-bold text-gray-900" id="stat-daily-total">¥0.00</div>
                <div class="text-xs text-gray-400 mt-1">仅统计“使用中”的物品</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1 bg-emerald-500"></div>
                <div class="text-sm font-medium text-gray-500 mb-1">已完结日均成本</div>
                <div class="text-lg font-bold text-gray-900" id="stat-retired-avg">¥0.00</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1 bg-orange-500"></div>
                <div class="text-sm font-medium text-gray-500 mb-1">历史最佳性价比</div>
                <div class="text-lg font-bold text-gray-900 truncate" id="stat-best-item">-</div>
                <div class="text-xs text-orange-600 font-medium" id="stat-best-val">¥0.00 /天</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 xl:col-span-3">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-24 border border-gray-100">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-800">
                        <i class="fa-solid fa-plus-circle text-indigo-500"></i> 新增物品
                    </h2>
                    <form id="itemForm" onsubmit="handleFormSubmit(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">物品名称</label>
                                <input type="text" id="itemName" required placeholder="例如：iPhone 15" 
                                    class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">购买价格 (¥)</label>
                                <input type="number" id="itemPrice" required min="0" step="0.01" placeholder="0.00" 
                                    class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">购买日期</label>
                                <input type="date" id="itemDate" required 
                                    class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition">
                            </div>
                        </div>

                        <button type="submit" 
                            class="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg shadow hover:shadow-md transition duration-200 flex justify-center items-center gap-2">
                            <span>开始追踪</span>
                        </button>
                    </form>
                    
                    </div>
            </div>

            <div class="lg:col-span-8 xl:col-span-9 space-y-6">
                
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <h2 class="font-bold text-gray-800">资产清单</h2>
                        <div class="flex gap-2">
                            <span class="text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded border border-green-100" id="badge-active">使用中: 0</span>
                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded border border-gray-200" id="badge-retired">已归档: 0</span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-xs font-semibold text-gray-500 border-b bg-gray-50">
                                    <th class="px-6 py-3 w-1/4">物品信息</th>
                                    <th class="px-6 py-3 text-center">状态</th>
                                    <th class="px-6 py-3 text-right">成本核算</th>
                                    <th class="px-6 py-3 text-right text-indigo-600">日均成本</th>
                                    <th class="px-6 py-3 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody" class="text-sm divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-5 border border-gray-100">
                        <h3 class="text-sm font-bold text-gray-700 mb-4">每日使用成本排行 (Top 5)</h3>
                        <div class="relative h-60"><canvas id="costChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-5 border border-gray-100">
                        <h3 class="text-sm font-bold text-gray-700 mb-4">净消耗价值占比</h3>
                        <div class="relative h-60"><canvas id="valueChart"></canvas></div>
                    </div>
                </div>

            </div>
        </div>

        <div class="mt-8 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden" id="ai-panel">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-indigo-50/30">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-robot text-indigo-600"></i>
                    <h2 class="font-bold text-gray-800">AI 资产顾问</h2>
                </div>
                <button onclick="generateAIAnalysis()" id="aiBtn" class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> 生成分析报告
                </button>
            </div>
            
            <div class="p-8 min-h-[150px]">
                <div id="ai-loading" class="hidden flex flex-col items-center justify-center py-8">
                    <div class="typing-loader mb-4"></div>
                    <span class="text-indigo-500 font-medium">AI 正在深度分析您的消费习惯...</span>
                </div>

                <div id="ai-result" class="prose max-w-none hidden"></div>

                <div id="ai-placeholder" class="flex flex-col items-center justify-center text-center py-8 text-gray-400">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-2xl text-gray-300">
                        <i class="fa-solid fa-lightbulb"></i>
                    </div>
                    <p class="text-lg font-medium text-gray-500">暂无分析数据</p>
                    <p class="text-sm max-w-md mt-1">点击右上角的“生成分析报告”按钮，让 AI 基于您的所有资产数据，为您生成一份专属的消费画像与省钱建议。</p>
                </div>
            </div>
        </div>

    </main>

    <div id="sellModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto transform transition-all scale-95">
            <div class="px-6 py-4 text-left">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-lg font-bold text-gray-900">结束使用物品</p>
                    <div class="modal-close cursor-pointer" onclick="closeModal('sellModal')"><i class="fa-solid fa-times text-gray-500"></i></div>
                </div>
                <div class="my-4">
                    <p class="text-sm text-gray-600 mb-4">您正在结束 <span id="modalItemName" class="font-bold text-indigo-600"></span> 的使用周期。</p>
                    <input type="hidden" id="modalItemId">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">结束日期 (出售/报废)</label>
                        <input type="date" id="modalSellDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:border-indigo-500">
                    </div>
                    <div class="mb-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">回血金额 (卖出价格)</label>
                        <input type="number" id="modalSellPrice" value="0" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:border-indigo-500">
                        <p class="text-xs text-gray-400 mt-1">如果是报废或丢弃，请填 0</p>
                    </div>
                </div>
                <div class="flex justify-end pt-2 gap-2">
                    <button onclick="closeModal('sellModal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition">取消</button>
                    <button onclick="confirmSell()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium shadow transition">确认结束</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto transform transition-all scale-95">
            <div class="px-6 py-4 text-left">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-lg font-bold text-gray-900">AI 服务设置</p>
                    <div class="modal-close cursor-pointer" onclick="closeModal('settingsModal')"><i class="fa-solid fa-times text-gray-500"></i></div>
                </div>
                <div class="my-4 space-y-4">
                    <div class="p-3 bg-blue-50 text-blue-800 text-xs rounded border border-blue-100">数据将直接发送至您的 API 服务商。Key 仅保存在本地。</div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API 地址 (Base URL)</label>
                        <input type="text" id="apiBaseUrl" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                        <input type="password" id="apiKey" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">模型名称</label>
                        <input type="text" id="apiModel" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 text-sm">
                    </div>
                </div>
                <div class="flex justify-end pt-2 gap-2">
                    <button onclick="closeModal('settingsModal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition">关闭</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium shadow transition">保存</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto transform transition-all scale-95">
            <div class="px-6 py-4 text-left">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-lg font-bold text-gray-900">修改物品信息</p>
                    <div class="modal-close cursor-pointer" onclick="closeModal('editModal')"><i class="fa-solid fa-times text-gray-500"></i></div>
                </div>
                
                <input type="hidden" id="editItemId">
                
                <div class="my-4 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">物品名称</label>
                        <input type="text" id="editItemName" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">购买价格</label>
                            <input type="number" id="editItemPrice" min="0" step="0.01" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">购买日期</label>
                            <input type="date" id="editItemDate" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 text-sm">
                        </div>
                    </div>

                    <div id="editRetiredFields" class="hidden pt-4 border-t border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">归档信息</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">回血金额</label>
                                <input type="number" id="editItemSellPrice" min="0" step="0.01" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">结束日期</label>
                                <input type="date" id="editItemSellDate" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg outline-none focus:border-indigo-500 text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-2 gap-2">
                    <button onclick="closeModal('editModal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition">取消</button>
                    <button onclick="saveEdit()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium shadow transition">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 数据 ---
        let items = JSON.parse(localStorage.getItem('proCostItems')) || [];
        let aiConfig = JSON.parse(localStorage.getItem('proCostAIConfig')) || {
            baseUrl: 'https://api.openai.com/v1', key: '', model: 'gpt-3.5-turbo'
        };
        let charts = { cost: null, value: null };

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('itemDate').valueAsDate = new Date();
            renderApp();
            const lastAnalysis = localStorage.getItem('lastAIAnalysis');
            if(lastAnalysis) {
                document.getElementById('ai-placeholder').classList.add('hidden');
                document.getElementById('ai-result').classList.remove('hidden');
                document.getElementById('ai-result').innerHTML = marked.parse(lastAnalysis);
            }
        });

        // --- 增删改查核心 ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('itemName').value;
            const price = parseFloat(document.getElementById('itemPrice').value);
            const date = document.getElementById('itemDate').value;
            if (!name || isNaN(price) || !date) return;

            items.push({
                id: Date.now(),
                name, price, buyDate: date,
                status: 'active', sellDate: null, sellPrice: 0,
                locked: false
            });
            saveData();
            document.getElementById('itemForm').reset();
            document.getElementById('itemDate').valueAsDate = new Date();
            renderApp();
        }

        function deleteItem(id) {
            const item = items.find(i => i.id === id);
            if (item && item.locked) { alert("该物品已锁定，请先解锁。"); return; }
            if(confirm('确定要删除吗？数据无法恢复。')) {
                items = items.filter(item => item.id !== id);
                saveData();
                renderApp();
            }
        }

        function toggleLock(id) {
            const index = items.findIndex(i => i.id === id);
            if (index !== -1) {
                items[index].locked = !items[index].locked;
                saveData();
                renderApp();
            }
        }

        // --- 编辑逻辑 ---
        function openEditModal(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;
            if (item.locked) { alert("该物品已锁定，请先解锁。"); return; }

            document.getElementById('editItemId').value = id;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemPrice').value = item.price;
            document.getElementById('editItemDate').value = item.buyDate;

            const retiredFields = document.getElementById('editRetiredFields');
            if (item.status === 'retired') {
                retiredFields.classList.remove('hidden');
                document.getElementById('editItemSellPrice').value = item.sellPrice || 0;
                document.getElementById('editItemSellDate').value = item.sellDate || '';
            } else {
                retiredFields.classList.add('hidden');
            }

            toggleModal('editModal', true);
        }

        function saveEdit() {
            const id = parseInt(document.getElementById('editItemId').value);
            const name = document.getElementById('editItemName').value;
            const price = parseFloat(document.getElementById('editItemPrice').value);
            const buyDate = document.getElementById('editItemDate').value;
            
            const index = items.findIndex(i => i.id === id);
            if (index !== -1) {
                items[index].name = name;
                items[index].price = price;
                items[index].buyDate = buyDate;
                if (items[index].status === 'retired') {
                    const sellPrice = parseFloat(document.getElementById('editItemSellPrice').value);
                    const sellDate = document.getElementById('editItemSellDate').value;
                    items[index].sellPrice = isNaN(sellPrice) ? 0 : sellPrice;
                    items[index].sellDate = sellDate;
                }
                saveData();
                renderApp();
            }
            toggleModal('editModal', false);
        }

        // --- Modal 通用 ---
        function openSellModal(id) {
            const item = items.find(i => i.id === id);
            if (item && item.locked) { alert("该物品已锁定，请先解锁。"); return; }
            document.getElementById('modalItemId').value = id;
            document.getElementById('modalItemName').innerText = item.name;
            document.getElementById('modalSellDate').valueAsDate = new Date();
            document.getElementById('modalSellPrice').value = 0;
            toggleModal('sellModal', true);
        }

        function openSettingsModal() {
            document.getElementById('apiBaseUrl').value = aiConfig.baseUrl;
            document.getElementById('apiKey').value = aiConfig.key;
            document.getElementById('apiModel').value = aiConfig.model;
            toggleModal('settingsModal', true);
        }

        function closeModal(id) { toggleModal(id, false); }
        function toggleModal(id, show) {
            const m = document.getElementById(id);
            const c = m.querySelector('.modal-container');
            if(show) {
                m.classList.remove('opacity-0', 'pointer-events-none');
                c.classList.remove('scale-95'); c.classList.add('scale-100');
                document.body.classList.add('modal-active');
            } else {
                m.classList.add('opacity-0', 'pointer-events-none');
                c.classList.remove('scale-100'); c.classList.add('scale-95');
                document.body.classList.remove('modal-active');
            }
        }

        function confirmSell() {
            const id = parseInt(document.getElementById('modalItemId').value);
            const sellDate = document.getElementById('modalSellDate').value;
            const sellPrice = parseFloat(document.getElementById('modalSellPrice').value) || 0;
            const index = items.findIndex(i => i.id === id);
            if (index !== -1) {
                if (new Date(sellDate) < new Date(items[index].buyDate)) { alert('结束日期不能早于购买日期！'); return; }
                items[index].status = 'retired';
                items[index].sellDate = sellDate;
                items[index].sellPrice = sellPrice;
                saveData();
                renderApp();
            }
            closeModal('sellModal');
        }

        function saveSettings() {
            aiConfig = {
                baseUrl: document.getElementById('apiBaseUrl').value.replace(/\/+$/, ""),
                key: document.getElementById('apiKey').value,
                model: document.getElementById('apiModel').value
            };
            localStorage.setItem('proCostAIConfig', JSON.stringify(aiConfig));
            closeModal('settingsModal');
            alert("API 配置已保存");
        }

        // --- 渲染与计算 ---
        function renderTable() {
            const tbody = document.getElementById('itemsTableBody');
            tbody.innerHTML = '';
            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-gray-400">暂无数据，请添加资产</td></tr>`;
                return;
            }

            const sortedItems = [...items].sort((a, b) => {
                if (a.status !== b.status) return a.status === 'active' ? -1 : 1;
                return getMetrics(b).dailyCost - getMetrics(a).dailyCost;
            });

            sortedItems.forEach(item => {
                const m = getMetrics(item);
                const isRetired = item.status === 'retired';
                const isLocked = item.locked === true;
                
                const tr = document.createElement('tr');
                tr.className = `group border-b border-gray-50 last:border-0 hover:bg-gray-50 transition 
                    ${isRetired ? 'bg-gray-50/50' : ''} 
                    ${isLocked ? 'border-l-4 border-l-yellow-400 bg-yellow-50/30' : ''}`;

                const statusBadge = isRetired 
                    ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-600"><i class="fa-solid fa-check-circle"></i> 已结束</span>`
                    : `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700"><i class="fa-solid fa-clock"></i> 使用中</span>`;

                let costDetail = `原价 ¥${item.price.toLocaleString()}`;
                if (isRetired && item.sellPrice > 0) costDetail += `<br><span class="text-green-600 text-xs">回血 -¥${item.sellPrice.toLocaleString()}</span>`;

                const btnClass = "text-gray-500 hover:text-indigo-600 px-2 py-1 transition disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:text-gray-500";
                const delBtnClass = "text-gray-400 hover:text-red-500 px-2 py-1 transition disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:text-gray-400";

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${isRetired ? 'text-gray-500 line-through decoration-gray-400' : 'text-gray-900'}">${item.name}</span>
                                ${isLocked ? '<i class="fa-solid fa-lock text-yellow-500 text-xs" title="已锁定"></i>' : ''}
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5">${item.buyDate} ${isRetired ? ' -> ' + item.sellDate : ''}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        ${statusBadge}
                        <div class="text-xs text-gray-500 mt-1">${m.days} 天</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="text-sm text-gray-600">${costDetail}</div>
                        <div class="text-xs font-bold text-gray-700 border-t border-gray-200 mt-1 pt-1 inline-block">净耗 ¥${m.netCost.toLocaleString()}</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="text-lg font-bold ${isRetired ? 'text-gray-500' : 'text-indigo-600'}">¥${m.dailyCost.toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="toggleLock(${item.id})" class="${btnClass} ${isLocked ? 'text-yellow-600' : ''}" title="${isLocked ? '解锁' : '锁定'}">
                                <i class="fa-solid ${isLocked ? 'fa-lock' : 'fa-lock-open'}"></i>
                            </button>
                            <button onclick="openEditModal(${item.id})" class="${btnClass}" ${isLocked ? 'disabled' : ''} title="修改">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            ${!isRetired ? 
                                `<button onclick="openSellModal(${item.id})" class="${btnClass}" ${isLocked ? 'disabled' : ''} title="结束使用">
                                    <i class="fa-solid fa-stop"></i>
                                </button>` : ''
                            }
                            <button onclick="deleteItem(${item.id})" class="${delBtnClass}" ${isLocked ? 'disabled' : ''} title="删除">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 辅助与统计 ---
        function getMetrics(item) {
            const buyDate = new Date(item.buyDate);
            let endDate = new Date();
            if (item.status === 'retired' && item.sellDate) endDate = new Date(item.sellDate);
            let days = Math.ceil((endDate - buyDate) / (1000 * 60 * 60 * 24));
            if (days < 1) days = 1;
            const netCost = item.price - (item.sellPrice || 0);
            return { days, netCost, dailyCost: netCost / days };
        }

        function renderStats() {
            let totalNet = 0, activeDailyTotal = 0, retiredSumDaily = 0, retiredCount = 0;
            let best = { val: Infinity, name: '-' };
            items.forEach(item => {
                const m = getMetrics(item);
                totalNet += m.netCost;
                if (item.status === 'active') activeDailyTotal += m.dailyCost;
                else { retiredSumDaily += m.dailyCost; retiredCount++; }
                if (m.dailyCost < best.val) best = { val: m.dailyCost, name: item.name };
            });
            document.getElementById('stat-total-net').innerText = `¥${totalNet.toLocaleString()}`;
            document.getElementById('stat-daily-total').innerText = `¥${activeDailyTotal.toFixed(2)}`;
            const retiredAvg = retiredCount > 0 ? (retiredSumDaily / retiredCount) : 0;
            document.getElementById('stat-retired-avg').innerText = `¥${retiredAvg.toFixed(2)}`;
            if (items.length > 0) {
                document.getElementById('stat-best-item').innerText = best.name;
                document.getElementById('stat-best-val').innerText = `¥${best.val.toFixed(2)} /天`;
            }
        }

        function renderCharts() {
            if (items.length === 0) return;
            const data = items.map(i => ({ ...i, ...getMetrics(i) }));
            const sortedByCost = [...data].sort((a, b) => b.dailyCost - a.dailyCost).slice(0, 5);
            
            if (charts.cost) charts.cost.destroy();
            charts.cost = new Chart(document.getElementById('costChart'), {
                type: 'bar',
                data: {
                    labels: sortedByCost.map(i => i.name),
                    datasets: [{
                        label: '日均成本',
                        data: sortedByCost.map(i => i.dailyCost),
                        backgroundColor: sortedByCost.map(i => i.status === 'active' ? '#4f46e5' : '#9ca3af'),
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });

            if (charts.value) charts.value.destroy();
            charts.value = new Chart(document.getElementById('valueChart'), {
                type: 'doughnut',
                data: {
                    labels: data.map(i => i.name),
                    datasets: [{
                        data: data.map(i => i.netCost),
                        backgroundColor: ['#4f46e5', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1', '#cbd5e1'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
            });
        }

        function exportData() {
            if (items.length === 0) return alert("无数据");
            const blob = new Blob([JSON.stringify(items, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `cost_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click(); URL.revokeObjectURL(url);
        }
        function importData(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) { if(confirm(`确认导入？`)) { items = json; saveData(); renderApp(); } }
                } catch (err) { alert("格式错误"); }
                input.value = '';
            };
            reader.readAsText(file);
        }
        function clearAllData() { if(confirm('确定清空？')) { items = []; saveData(); renderApp(); localStorage.removeItem('lastAIAnalysis'); renderApp(); document.getElementById('ai-result').classList.add('hidden'); document.getElementById('ai-placeholder').classList.remove('hidden'); } }
        function saveData() { localStorage.setItem('proCostItems', JSON.stringify(items)); }
        function renderApp() { renderTable(); renderStats(); renderCharts(); }

        // --- AI ---
        async function generateAIAnalysis() {
            if (!aiConfig.key) return openSettingsModal() || alert("请先配置 API");
            if (items.length === 0) return alert("请先添加物品");
            
            // 自动滚动到底部
            document.getElementById('ai-panel').scrollIntoView({ behavior: 'smooth' });

            const btn = document.getElementById('aiBtn');
            const placeholder = document.getElementById('ai-placeholder');
            const loading = document.getElementById('ai-loading');
            const result = document.getElementById('ai-result');
            
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> 生成中...';
            placeholder.classList.add('hidden'); result.classList.add('hidden'); loading.classList.remove('hidden');

            const dataSummary = items.map(i => {
                const m = getMetrics(i);
                return `物品: ${i.name}, 状态: ${i.status}, 购入: ${i.buyDate}, 价格: ${i.price}, 日均: ${m.dailyCost.toFixed(2)}`;
            }).join('\n');
            const prompt = `基于以下资产数据，给出犀利点评(Markdown):\n${dataSummary}\n包含: 消费画像、黑榜(高日耗)、红榜(高性价比)、建议。`;

            try {
                const res = await fetch(`${aiConfig.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.key}` },
                    body: JSON.stringify({ model: aiConfig.model, messages: [{ role: "user", content: prompt }] })
                });
                const data = await res.json();
                const content = data.choices[0].message.content;
                loading.classList.add('hidden'); result.classList.remove('hidden');
                result.innerHTML = marked.parse(content);
                localStorage.setItem('lastAIAnalysis', content);
            } catch (e) { alert("AI 分析出错: " + e.message); loading.classList.add('hidden'); placeholder.classList.remove('hidden'); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> 生成分析报告'; }
        }
    </script>
</body>
</html>